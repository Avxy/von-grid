define("nexus",{grid:null,board:null,mouse:null,scene:null,input:null,plane:null}),define("tower",{tileAction:new vg.Signal,objAction:new vg.Signal,userAction:new vg.Signal,save:new vg.Signal,TILE_CHANGE_HEIGHT:"cell.change.height",TILE_ADD:"cell.add",TILE_REMOVE:"cell.remove",TILE_CHANGE_WALKABLE:"cell.change.walkable"}),define("walkableTile",function(){function e(e,t,i){t&&r.mouse.down&&n(t)}function t(e,t,i){t&&n(t)}function i(e,t,i){}function n(e){return e?(e.cell.walkable=!e.cell.walkable,o.tileAction.dispatch(o.TILE_CHANGE_WALKABLE,e),e):void 0}var o=require("tower"),r=require("nexus");return{onOver:e,onDown:t,onUp:i,action:n}}),define("removeTile",function(){function e(e,t,i){t&&r.mouse.down&&n(t)}function t(e,t,i){t&&n(t)}function i(e,t,i){}function n(e){r.board.removeTile(e),o.tileAction.dispatch(o.TILE_REMOVE,e)}var o=require("tower"),r=require("nexus");return{onOver:e,onDown:t,onUp:i,action:n}}),define("data",{_store:{},changed:new vg.Signal,get:function(e){return this._store[e]||null},set:function(e,t){this.changed.dispatch(e,this._store[e],t),this._store[e]=t},save:function(){window.localStorage.vongrid=JSON.stringify(this._store)},load:function(e){var t=window.localStorage.vongrid;if(e||t)try{this._store=e||JSON.parse(t),this.changed.dispatch("load-success",this._store)}catch(i){console.warn("Error loading editor data"),this.changed.dispatch("load-failure")}}}),define("addTile",function(){function e(e,t,i){!t&&a.mouse.down&&n(e)}function t(e,t,i){t||n(e)}function i(e,t,i){}function n(e){if(e&&!a.board.getTileAtCell(e)){var t=new vg.Cell;t.copy(e),t.h=Math.abs(a.mouse.wheel*l);var i=a.grid.generateTile(t,.95);return a.board.addTile(i),r.tileAction.dispatch(r.TILE_ADD,i),i}}function o(e,t,i){"settings"===e&&(l=i.heightStep),"load-success"===e&&(l=t.settings.heightStep)}var r=require("tower"),a=require("nexus"),s=require("data"),l=3;return s.changed.add(o,this),{onOver:e,onDown:t,onUp:i,action:n}}),define("motor",function(){function e(){c=!1,window.requestAnimationFrame(o),window.addEventListener("focus",a,!1),window.addEventListener("blur",s,!1)}function t(){c=!0,window.removeEventListener("focus",a,!1),window.removeEventListener("blur",s,!1)}function i(e,t){var i=l(e.toString()),n=r(i);-1===n&&u.push({func:e,scope:t,key:i})}function n(e){var t=l(e.toString()),i=r(t);-1!==i&&u.splice(i,1)}function o(){if(!c){window.requestAnimationFrame(o);for(var e=0;e<u.length;e++){var t=u[e];t.func.call(t.scope||null)}}}function r(e){var t,i=-1;for(t=0;t<u.length;t++)if(i=u[t].key,i===e)return t;return-1}function a(e){c=!1,o()}function s(e){c=!0}function l(e){var t,i,n,o=0;if(0===e.length)return o;for(t=0,n=e.length;n>t;t++)i=e.charCodeAt(t),o=(o<<5)-o+i,o|=0;return o}var c=!1,u=[];return{on:e,off:t,add:i,remove:n}}),define("keyboard",function(){function e(e){switch(e.keyCode){case 16:i.shift=!0;break;case 17:i.ctrl=!0}i.signal.dispatch(i.eventType.DOWN,e.keyCode)}function t(e){switch(e.keyCode){case 16:i.shift=!1;break;case 17:i.ctrl=!1}i.signal.dispatch(i.eventType.UP,e.keyCode)}var i={shift:!1,ctrl:!1,eventType:{DOWN:"down",UP:"up"},signal:new vg.Signal,on:function(){document.addEventListener("keydown",e,!1),document.addEventListener("keyup",t,!1)},off:function(){document.removeEventListener("keydown",e),document.removeEventListener("keyup",t)},code:{A:"A".charCodeAt(0),B:"B".charCodeAt(0),C:"C".charCodeAt(0),D:"D".charCodeAt(0),E:"E".charCodeAt(0),F:"F".charCodeAt(0),G:"G".charCodeAt(0),H:"H".charCodeAt(0),I:"I".charCodeAt(0),J:"J".charCodeAt(0),K:"K".charCodeAt(0),L:"L".charCodeAt(0),M:"M".charCodeAt(0),N:"N".charCodeAt(0),O:"O".charCodeAt(0),P:"P".charCodeAt(0),Q:"Q".charCodeAt(0),R:"R".charCodeAt(0),S:"S".charCodeAt(0),T:"T".charCodeAt(0),U:"U".charCodeAt(0),V:"V".charCodeAt(0),W:"W".charCodeAt(0),X:"X".charCodeAt(0),Y:"Y".charCodeAt(0),Z:"Z".charCodeAt(0),ZERO:"0".charCodeAt(0),ONE:"1".charCodeAt(0),TWO:"2".charCodeAt(0),THREE:"3".charCodeAt(0),FOUR:"4".charCodeAt(0),FIVE:"5".charCodeAt(0),SIX:"6".charCodeAt(0),SEVEN:"7".charCodeAt(0),EIGHT:"8".charCodeAt(0),NINE:"9".charCodeAt(0),NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,NUMPAD_MULTIPLY:106,NUMPAD_ADD:107,NUMPAD_ENTER:108,NUMPAD_SUBTRACT:109,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,COLON:186,EQUALS:187,UNDERSCORE:189,QUESTION_MARK:191,TILDE:192,OPEN_BRACKET:219,BACKWARD_SLASH:220,CLOSED_BRACKET:221,QUOTES:222,BACKSPACE:8,TAB:9,CLEAR:12,ENTER:13,SHIFT:16,CTRL:17,ALT:18,CAPS_LOCK:20,ESC:27,SPACEBAR:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,HELP:47,NUM_LOCK:144}};return i}),define("toolbag",function(){function e(){v=o.grid.pixelToCell(o.input.editorWorldPos),!r.ctrl&&o.mouse.down&&"ADD_TILE"===ui.activeTool.name&&o.mouse.allHits&&o.mouse.allHits.length&&(v.equals(g)||s.action(v,null),g.copy(v))}function t(e){switch(e){case ui.Tools.ADD_TILE:u=s;break;case ui.Tools.REMOVE_TILE:u=l;break;case ui.Tools.WALK_TILE:u=c;break;default:u=null}}function i(e,t,i){if(!r.ctrl&&null!==i&&!o.mouse.rightDown&&u)switch(e){case vg.MouseCaster.WHEEL:if(o.scene.controls.enabled=!1,r.shift&&t&&o.grid.autogenerated){if(!t.cell)return void t.dispose();E.copy(t.cell),E.tile=null;var a=d-i,c=E.h;if(E.h+=a>0?-h:h,E.h<1&&(E.h=1),o.mouse.wheel=Math.round(E.h/h+(a>0?-1:1)),d=o.mouse.wheel,c===E.h)return;l.action(t);var g=s.action(E);g.select(),n.tileAction.dispatch(n.TILE_CHANGE_HEIGHT,g)}break;case vg.MouseCaster.OVER:u.onOver(v,t,i);break;case vg.MouseCaster.OUT:break;case vg.MouseCaster.DOWN:u.onDown(v,t,i);break;case vg.MouseCaster.UP:u.onUp(v,t,i)}}var n=require("tower"),o=require("nexus"),r=require("keyboard"),a=require("motor"),s=require("addTile"),l=require("removeTile"),c=require("walkableTile"),u=s,h=3,d=1,v=null,g=new THREE.Vector3,E=new vg.Cell;return n.userAction.add(i,this),ui.on(ui.Events.TOOL_CHANGE,t),a.add(e),{}}),window.addEventListener("load",function(e){function t(){10>D&&(D++,10===D&&(S.active=!0)),p&&(f--,0===f&&(p=!1,s.set("map",g),s.save(),console.log("Map saved"))),S.update(),M.update(),_.update(),T.render()}function i(){S.active=!1,D=0}function n(){p=!0,f=E,g=m.toJSON()}function o(e){m.fromJSON(e),w.setGrid(m),e.autogenerated&&w.generateTilemap(),_.generatePlane(),_.generateHoverMesh();var t=s.get("settings");_.updatePlane(t.planeColor,t.planeSize),console.log("Map load complete")}function r(){var e=null;g=m.toJSON();try{e=JSON.stringify(g,null,"	"),e=e.replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(t){e=JSON.stringify(g)}a(e,"hex-map.json")}function a(e,t){var i=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(i);L.href=n,L.download=t||"data.json",L.target="_blank";var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),L.dispatchEvent(o)}var s=require("data"),l=require("tower"),c=require("nexus"),u=require("keyboard"),h=require("motor"),d=require("Input"),v=require("EditorPlane");s.load();var g=s.get("map"),E=200,f=10,p=!1,A=document.createElement("input");A.type="file",A.addEventListener("change",function(e){var t=A.files[0];if(t){var i=new FileReader;return i.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(i){return void console.warn("File is not json format")}o(t)},i.readAsText(t),!1}}),ui.on("error",function(e){console.warn(e)}),ui.on(ui.Events.SAVE_MAP,function(){r()}),ui.on(ui.Events.LOAD_MAP,function(){A.click()}),u.on(),h.on();var C=document.getElementById("view"),T=new vg.Scene({element:C,cameraPosition:{x:0,y:300,z:120}},{maxPolarAngle:Math.PI/2-.01});c.scene=T,T.controls.addEventListener("wheel",i);var m=new vg.HexGrid;c.grid=m;var w=new vg.Board(m);c.board=w;var S=new vg.MouseCaster(w.group,T.camera,C);c.mouse=S;var M=new d(w.group,S);c.input=M;var _=new v(w.group,m,S);if(c.plane=_,l.tileAction.add(n,this),l.save.add(n,this),T.focusOn(w.group),g)ui.trigger(ui.Events.UPDATE_SETTINGS,s.get("settings")),o(g);else{m.generate({size:5}),w.generateTilemap(),g=m.toJSON(),s.set("map",g);var P={mapSize:m.size,cellSize:m.cellSize,planeSize:_.planeSize,heightStep:3,maxTileHeight:30,planeColor:"#ffffff"};s.set("settings",P),console.log("Created a new map"),s.save(),_.generatePlane(),_.generateHoverMesh()}ui.trigger(ui.Events.UPDATE_SETTINGS,s.get("settings")),T.add(w.group),ui.on(ui.Events.UPDATE_SETTINGS,function(e){if(_.updatePlane(e.planeColor,e.planeSize),s.set("settings",e),n(),e.mapSize===m.size){if(e.cellSize===m.cellSize)return;m.updateCellSize(e.cellSize),_.generatePlane(),_.generateHoverMesh(),m.autogenerated&&w.generateTilemap()}else m.updateCellSize(e.cellSize),m.generate({size:e.mapSize}),_.generatePlane(),_.generateHoverMesh(),m.autogenerated&&w.generateTilemap()}),h.add(t);var D=10,L=document.createElement("a");L.style.display="none",document.body.appendChild(L)}),define("Input",function(){var e=require("tower"),t=require("nexus"),i=require("keyboard"),n=function(e,t){this.mouse=t,this.mouse.signal.add(this.onMouse,this),this.mouseDelta=new THREE.Vector3,this.mousePanMinDistance=.1,this.heightStep=5,this.editorWorldPos=new THREE.Vector3,this.overTile=null,this._travel=0};return n.prototype={update:function(){var e=this.mouse.allHits[0];e&&(this.editorWorldPos.x=e.point.x,this.editorWorldPos.y=e.point.y,this.editorWorldPos.z=e.point.z);var n=this.mouseDelta.x-this.mouse.screenPosition.x,o=this.mouseDelta.y-this.mouse.screenPosition.y;this._travel+=Math.sqrt(n*n+o*o),i.ctrl?t.scene.controls.enabled=!0:t.scene.controls.enabled=!1},onMouse:function(t,i){var n;switch(this.mouse.allHits&&this.mouse.allHits[0]&&(n=this.mouse.allHits[0]),t){case vg.MouseCaster.WHEEL:e.userAction.dispatch(vg.MouseCaster.WHEEL,this.overTile,i);break;case vg.MouseCaster.OVER:i&&(this.overTile=i.select()),e.userAction.dispatch(vg.MouseCaster.OVER,this.overTile,n);break;case vg.MouseCaster.OUT:i&&(i.deselect(),this.overTile=null),e.userAction.dispatch(vg.MouseCaster.OUT,this.overTile,n);break;case vg.MouseCaster.DOWN:this.mouseDelta.copy(this.mouse.screenPosition),e.userAction.dispatch(vg.MouseCaster.DOWN,this.overTile,n),this._travel=0;break;case vg.MouseCaster.UP:if(this._travel>this.mousePanMinDistance)break;e.userAction.dispatch(vg.MouseCaster.UP,this.overTile,n);break;case vg.MouseCaster.CLICK:e.userAction.dispatch(vg.MouseCaster.CLICK,this.overTile,n)}}},n}),define("EditorPlane",function(){function e(e,t,i){this.nexus=require("nexus"),this.tower=require("tower"),this.mesh=null,this.material=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),this.scene=e,this.grid=t,this.mouse=i,this.board=this.nexus.board,this.hoverMesh=null,this.planeSize=t.size,this._actualSize=t.size*t.cellSize*2}return e.prototype={updatePlane:function(e,t){var i=parseInt(e.replace(/^#/,""),16);if(this.material.color.setHex(i),this.planeSize!==t){switch(this.planeSize=t,this.grid.type){case vg.HEX:this._actualSize=t*(.5*vg.SQRT3)*this.grid._cellWidth+this.grid.cellSize;break;case vg.SQR:this._actualSize=t*this.grid.cellSize*2}this.generatePlane()}},generatePlane:function(){var e;switch(this.mesh&&this.mesh.parent&&(this.mesh.parent.remove(this.mesh),this.mesh.geometry.dispose()),this.board.generateOverlay(this.planeSize),this.grid.type){case vg.HEX:e=new THREE.CircleGeometry(this._actualSize,6);break;case vg.SQR:e=new THREE.PlaneGeometry(this._actualSize,this._actualSize,1,1);break;default:console.warn("[EditorPlane.generatePlane] no grid type set")}this.mesh=new THREE.Mesh(e,this.material),this.mesh.rotation.x=90*vg.DEG_TO_RAD,this.grid.type===vg.HEX&&(this.mesh.rotation.z=90*vg.DEG_TO_RAD),this.scene.add(this.mesh)},generateHoverMesh:function(){this.hoverMesh&&this.hoverMesh.parent&&this.hoverMesh.parent.remove(this.hoverMesh),this.hoverMesh=this.grid.generateTilePoly(new THREE.MeshBasicMaterial({color:1748735,side:THREE.DoubleSide})),this.nexus.scene.container.add(this.hoverMesh)},update:function(){if(this.mouse.allHits.length&&!this.mouse.pickedObject){var e=this.grid.pixelToCell(this.nexus.input.editorWorldPos);this.hoverMesh.position.copy(this.grid.cellToPixel(e)),this.hoverMesh.position.y+=.1,this.hoverMesh.visible=!0}else this.hoverMesh.visible=!1}},e});
//# sourceMappingURL=app.js.map
