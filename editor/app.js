window.addEventListener("load",function(e){function t(){10>N&&(N++,10===N&&(w.active=!0)),f&&(A--,0===A&&(f=!1,a.set("map",g),a.save(),console.log("Map saved"))),w.update(),S.update(),P.update(),C.render()}function i(){w.active=!1,N=0}function o(){f=!0,A=E,g=T.toJSON()}function n(e){T.fromJSON(e),M.setGrid(T),e.autogenerated&&M.generateTilemap();var t=20;P.generatePlane(t*t*1.8,t*t*1.8),M.generateOverlay(),ui.trigger(ui.Events.UPDATE_SETTINGS,{mapSize:T.size,cellSize:T.cellSize}),console.log("Map load complete")}function r(){var e=null;g=T.toJSON();try{e=JSON.stringify(g,null,"	"),e=e.replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(t){e=JSON.stringify(g)}s(e,"hex-map.json")}function s(e,t){var i=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(i);y.href=o,y.download=t||"data.json",y.target="_blank";var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),y.dispatchEvent(n)}var a=require("data"),l=require("tower"),c=require("nexus"),u=require("keyboard"),d=require("motor"),h=require("Input"),v=require("EditorPlane");a.load();var g=a.get("map"),E=200,A=10,f=!1,p=document.createElement("input");p.type="file",p.addEventListener("change",function(e){var t=p.files[0];if(t){var i=new FileReader;return i.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(i){return void console.warn("File is not json format")}n(t)},i.readAsText(t),!1}}),ui.on("error",function(e){console.warn(e)}),ui.on(ui.Events.SAVE_MAP,function(){return r(),!1}),ui.on(ui.Events.LOAD_MAP,function(){p.click()}),u.on(),d.on();var m=document.getElementById("view"),C=new vg.Scene({element:m,cameraPosition:{x:0,y:300,z:120}},{maxPolarAngle:Math.PI/2-.01});C.controls.addEventListener("wheel",i);var T=new vg.HexGrid,M=new vg.Board(T),w=new vg.MouseCaster(M.group,C.camera,m),S=new h(M.group,w),P=new v(M.group,T,w);if(c.input=S,c.plane=P,c.board=M,c.grid=T,c.scene=C,c.mouse=w,l.tileAction.add(o,this),C.focusOn(M.group),g)n(g);else{T.generate({size:5}),M.generateTilemap(),g=T.toJSON(),a.set("map",g),console.log("Created a new map"),ui.trigger(ui.Events.UPDATE_SETTINGS,{mapSize:5,cellSize:10});var D=20;P.generatePlane(D*D*1.8,D*D*1.8),M.generateOverlay()}C.add(M.group),ui.on(ui.Events.UPDATE_SETTINGS,function(e){if(e.mapSize===T.size){if(e.cellSize===T.cellSize)return;T.updateCellSize(e.cellSize);var t=20;P.generatePlane(t*t*1.8,t*t*1.8),M.generateOverlay(),T.autogenerated&&M.generateTilemap()}else T.updateCellSize(e.cellSize),T.generate({size:e.mapSize}),t=20,P.generatePlane(t*t*1.8,t*t*1.8),M.generateOverlay(),T.autogenerated&&M.generateTilemap();o()}),d.add(t);var N=10,y=document.createElement("a");y.style.display="none",document.body.appendChild(y)}),define("keyboard",function(){function e(e){switch(e.keyCode){case 16:i.shift=!0;break;case 17:i.ctrl=!0}i.signal.dispatch(i.eventType.DOWN,e.keyCode)}function t(e){switch(e.keyCode){case 16:i.shift=!1;break;case 17:i.ctrl=!1}i.signal.dispatch(i.eventType.UP,e.keyCode)}var i={shift:!1,ctrl:!1,eventType:{DOWN:"down",UP:"up"},signal:new vg.Signal,on:function(){document.addEventListener("keydown",e,!1),document.addEventListener("keyup",t,!1)},off:function(){document.removeEventListener("keydown",e),document.removeEventListener("keyup",t)},code:{A:"A".charCodeAt(0),B:"B".charCodeAt(0),C:"C".charCodeAt(0),D:"D".charCodeAt(0),E:"E".charCodeAt(0),F:"F".charCodeAt(0),G:"G".charCodeAt(0),H:"H".charCodeAt(0),I:"I".charCodeAt(0),J:"J".charCodeAt(0),K:"K".charCodeAt(0),L:"L".charCodeAt(0),M:"M".charCodeAt(0),N:"N".charCodeAt(0),O:"O".charCodeAt(0),P:"P".charCodeAt(0),Q:"Q".charCodeAt(0),R:"R".charCodeAt(0),S:"S".charCodeAt(0),T:"T".charCodeAt(0),U:"U".charCodeAt(0),V:"V".charCodeAt(0),W:"W".charCodeAt(0),X:"X".charCodeAt(0),Y:"Y".charCodeAt(0),Z:"Z".charCodeAt(0),ZERO:"0".charCodeAt(0),ONE:"1".charCodeAt(0),TWO:"2".charCodeAt(0),THREE:"3".charCodeAt(0),FOUR:"4".charCodeAt(0),FIVE:"5".charCodeAt(0),SIX:"6".charCodeAt(0),SEVEN:"7".charCodeAt(0),EIGHT:"8".charCodeAt(0),NINE:"9".charCodeAt(0),NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,NUMPAD_MULTIPLY:106,NUMPAD_ADD:107,NUMPAD_ENTER:108,NUMPAD_SUBTRACT:109,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,COLON:186,EQUALS:187,UNDERSCORE:189,QUESTION_MARK:191,TILDE:192,OPEN_BRACKET:219,BACKWARD_SLASH:220,CLOSED_BRACKET:221,QUOTES:222,BACKSPACE:8,TAB:9,CLEAR:12,ENTER:13,SHIFT:16,CTRL:17,ALT:18,CAPS_LOCK:20,ESC:27,SPACEBAR:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,HELP:47,NUM_LOCK:144}};return i}),define("nexus",{grid:null,board:null,mouse:null,scene:null,input:null,plane:null}),define("tower",{tileAction:new vg.Signal,objAction:new vg.Signal,userAction:new vg.Signal,saveMap:new vg.Signal,loadMap:new vg.Signal,TILE_CHANGE_HEIGHT:"cell.change.height",TILE_ADD:"cell.add",TILE_REMOVE:"cell.remove"}),define("Input",function(){var e=require("tower"),t=require("nexus"),i=require("keyboard"),o=function(e,o){this.mouse=o,this.mouse.signal.add(this.onMouse,this),this.mouseDelta=new THREE.Vector3,this.mousePanMinDistance=.1,this.heightStep=5,this.editorWorldPos=new THREE.Vector3,this.overTile=null,this._travel=0,i.signal.add(function(e,o){e===i.eventType.DOWN?o===i.code.SHIFT&&(t.scene.controls.enabled=!1):o===i.code.SHIFT&&(t.scene.controls.enabled=!0)},this)};return o.prototype={update:function(){var e=this.mouse.allHits[0];e&&(this.editorWorldPos.x=e.point.x,this.editorWorldPos.y=e.point.y,this.editorWorldPos.z=e.point.z);var t=this.mouseDelta.x-this.mouse.screenPosition.x,i=this.mouseDelta.y-this.mouse.screenPosition.y;this._travel+=Math.sqrt(t*t+i*i)},onMouse:function(t,i){var o;switch(this.mouse.allHits&&this.mouse.allHits[0]&&(o=this.mouse.allHits[0]),t){case vg.MouseCaster.WHEEL:e.userAction.dispatch(vg.MouseCaster.WHEEL,this.overTile,i);break;case vg.MouseCaster.OVER:i&&(this.overTile=i.select()),e.userAction.dispatch(vg.MouseCaster.OVER,this.overTile,o);break;case vg.MouseCaster.OUT:i&&(i.deselect(),this.overTile=null),e.userAction.dispatch(vg.MouseCaster.OUT,this.overTile,o);break;case vg.MouseCaster.DOWN:this.mouseDelta.copy(this.mouse.screenPosition),e.userAction.dispatch(vg.MouseCaster.DOWN,this.overTile,o),this._travel=0;break;case vg.MouseCaster.UP:if(this._travel>this.mousePanMinDistance)break;e.userAction.dispatch(vg.MouseCaster.UP,this.overTile,o);break;case vg.MouseCaster.CLICK:e.userAction.dispatch(vg.MouseCaster.CLICK,this.overTile,o)}}},o}),define("EditorPlane",function(){function e(e,t,i){this.nexus=require("nexus"),this.tower=require("tower"),this.geometry=null,this.mesh=null,this.material=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),this.scene=e,this.grid=t,this.mouse=i,this.hoverMesh=null}return e.prototype={generatePlane:function(e,t){this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.geometry=new THREE.PlaneBufferGeometry(e,e,1,1),this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.rotation.x=90*vg.DEG_TO_RAD,this.scene.add(this.mesh),this.hoverMesh&&this.hoverMesh.parent&&this.hoverMesh.parent.remove(this.hoverMesh),this.hoverMesh=this.grid.generateTilePoly(new THREE.MeshBasicMaterial({color:1748735,side:THREE.DoubleSide})),this.nexus.scene.container.add(this.hoverMesh)},update:function(){if(this.mouse.allHits.length&&!this.mouse.pickedObject){var e=this.grid.pixelToCell(this.nexus.input.editorWorldPos);this.hoverMesh.position.copy(this.grid.cellToPixel(e)),this.hoverMesh.position.y+=.1,this.hoverMesh.visible=!0}else this.hoverMesh.visible=!1}},e}),define("motor",function(){function e(){c=!1,window.requestAnimationFrame(n),window.addEventListener("focus",s,!1),window.addEventListener("blur",a,!1)}function t(){c=!0,window.removeEventListener("focus",s,!1),window.removeEventListener("blur",a,!1)}function i(e,t){var i=l(e.toString()),o=r(i);-1===o&&u.push({func:e,scope:t,key:i})}function o(e){var t=l(e.toString()),i=r(t);-1!==i&&u.splice(i,1)}function n(){if(!c){window.requestAnimationFrame(n);for(var e=0;e<u.length;e++){var t=u[e];t.func.call(t.scope||null)}}}function r(e){var t,i=-1;for(t=0;t<u.length;t++)if(i=u[t].key,i===e)return t;return-1}function s(e){c=!1,n()}function a(e){c=!0}function l(e){var t,i,o,n=0;if(0===e.length)return n;for(t=0,o=e.length;o>t;t++)i=e.charCodeAt(t),n=(n<<5)-n+i,n|=0;return n}var c=!1,u=[];return{on:e,off:t,add:i,remove:o}}),define("Editor",function(){function e(){u=r.grid.pixelToCell(r.input.editorWorldPos),r.mouse.down&&s.shift&&r.mouse.allHits&&r.mouse.allHits.length&&(u.equals(d)||i(u),d.copy(u))}function t(e,t,a){switch(e){case vg.MouseCaster.WHEEL:if(s.shift&&t){if(!t.cell)return void t.dispose();h.copy(t.cell),h.tile=null;var d=c-a,v=h.h;if(h.h+=d>0?-l:l,h.h<1&&(h.h=1),r.mouse.wheel=Math.round(h.h/l+(d>0?-1:1)),c=r.mouse.wheel,v===h.h)return;o(t);var g=i(h);g.select(),n.tileAction.dispatch(n.TILE_CHANGE_HEIGHT,g)}break;case vg.MouseCaster.OVER:s.shift&&(t&&r.mouse.rightDown?o(t):!t&&r.mouse.down&&i(u));break;case vg.MouseCaster.OUT:break;case vg.MouseCaster.DOWN:s.shift&&r.mouse.down&&a&&!t&&i(u);break;case vg.MouseCaster.UP:r.mouse.down&&a&&!t?i(u):r.mouse.rightDown&&t&&o(t)}}function i(e){if(e&&!r.board.getTileAtCell(e)){var t=new vg.Cell;t.copy(e),t.h=Math.abs(r.mouse.wheel*l);var i=r.grid.generateTile(t,.95);return r.board.addTile(i),n.tileAction.dispatch(n.TILE_ADD,i),i}}function o(e){r.board.removeTile(e),n.tileAction.dispatch(n.TILE_REMOVE,e)}var n=require("tower"),r=require("nexus"),s=require("keyboard"),a=require("motor"),l=3,c=1,u=null,d=new THREE.Vector3,h=new vg.Cell;return n.userAction.add(t,this),a.add(e),{}}),define("data",{_store:{},changed:new vg.Signal,get:function(e){return this._store[e]||null},set:function(e,t){this.changed.dispatch(e,this._store[e],t),this._store[e]=t},save:function(){window.localStorage.vongrid=JSON.stringify(this._store)},load:function(e){var t=window.localStorage.vongrid;if(e||t)try{this._store=e||JSON.parse(t),this.changed.dispatch("load-success")}catch(i){console.warn("Error loading editor data"),this.changed.dispatch("load-failure")}}});
//# sourceMappingURL=app.js.map
