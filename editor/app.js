window.addEventListener("load",function(e){function t(){10>S&&(S++,10===S&&(P.active=!0)),f&&(A--,0===A&&(f=!1,a.set("map",E),a.save(),console.log("Map saved"))),P.update(),y.update(),N.update(),M.render()}function o(){P.active=!1,S=0}function n(){f=!0,A=g,E=T.toJSON()}function i(e){T.fromJSON(e),D.setGrid(T),e.autogenerated&&D.generateTilemap(),console.log("Map load complete")}function r(){var e=null;E=T.toJSON();try{e=JSON.stringify(E,null,"	"),e=e.replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(t){e=JSON.stringify(E)}s(e,"hex-map.json")}function s(e,t){var o=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(o);_.href=n,_.download=t||"data.json",_.target="_blank";var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),_.dispatchEvent(i)}var a=require("data"),c=require("tower"),d=require("nexus"),l=require("keyboard"),u=require("motor"),h=require("Input"),v=require("EditorPlane");a.load();var E=a.get("map"),g=200,A=10,f=!1,m=document.getElementById("save-btn");m.onmouseup=function(e){return r(),!1};var p=document.getElementById("load-btn");p.addEventListener("click",function(){C.click()},!1);var C=document.createElement("input");C.type="file",C.addEventListener("change",function(e){var t=C.files[0];if(t){var o=new FileReader;return o.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(o){return void console.warn("File is not json format")}i(t)},o.readAsText(t),!1}}),l.on(),u.on();var w=document.getElementById("view"),M=new vg.Scene({element:w,cameraPosition:{x:0,y:300,z:120}},!0);M.controls.addEventListener("wheel",o);var T=new vg.HexGrid({rings:5,cellSize:10}),D=new vg.Board(T),P=new vg.MouseCaster(D.group,M.camera,w),y=new h(D.group,P),N=new v(D.group,T,P);d.input=y,d.plane=N,d.board=D,d.grid=T,d.scene=M,d.mouse=P;var O=20;N.generatePlane(O*O*1.8,O*O*1.8),N.addHoverMeshToGroup(M.container),D.generateOverlay(O),c.tileAction.add(n,this),M.focusOn(D.group),E?i(E):(D.generateTilemap(),E=T.toJSON(),a.set("map",E),console.log("Created a new map")),M.add(D.group),u.add(t);var S=10,_=document.createElement("a");_.style.display="none",document.body.appendChild(_)}),define("keyboard",function(){function e(e){switch(e.keyCode){case 16:o.shift=!0;break;case 17:o.ctrl=!0}o.signal.dispatch(o.eventType.DOWN,e.keyCode)}function t(e){switch(e.keyCode){case 16:o.shift=!1;break;case 17:o.ctrl=!1}o.signal.dispatch(o.eventType.UP,e.keyCode)}var o={shift:!1,ctrl:!1,eventType:{DOWN:"down",UP:"up"},signal:new vg.Signal,on:function(){document.addEventListener("keydown",e,!1),document.addEventListener("keyup",t,!1)},off:function(){document.removeEventListener("keydown",e),document.removeEventListener("keyup",t)},code:{A:"A".charCodeAt(0),B:"B".charCodeAt(0),C:"C".charCodeAt(0),D:"D".charCodeAt(0),E:"E".charCodeAt(0),F:"F".charCodeAt(0),G:"G".charCodeAt(0),H:"H".charCodeAt(0),I:"I".charCodeAt(0),J:"J".charCodeAt(0),K:"K".charCodeAt(0),L:"L".charCodeAt(0),M:"M".charCodeAt(0),N:"N".charCodeAt(0),O:"O".charCodeAt(0),P:"P".charCodeAt(0),Q:"Q".charCodeAt(0),R:"R".charCodeAt(0),S:"S".charCodeAt(0),T:"T".charCodeAt(0),U:"U".charCodeAt(0),V:"V".charCodeAt(0),W:"W".charCodeAt(0),X:"X".charCodeAt(0),Y:"Y".charCodeAt(0),Z:"Z".charCodeAt(0),ZERO:"0".charCodeAt(0),ONE:"1".charCodeAt(0),TWO:"2".charCodeAt(0),THREE:"3".charCodeAt(0),FOUR:"4".charCodeAt(0),FIVE:"5".charCodeAt(0),SIX:"6".charCodeAt(0),SEVEN:"7".charCodeAt(0),EIGHT:"8".charCodeAt(0),NINE:"9".charCodeAt(0),NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,NUMPAD_MULTIPLY:106,NUMPAD_ADD:107,NUMPAD_ENTER:108,NUMPAD_SUBTRACT:109,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,COLON:186,EQUALS:187,UNDERSCORE:189,QUESTION_MARK:191,TILDE:192,OPEN_BRACKET:219,BACKWARD_SLASH:220,CLOSED_BRACKET:221,QUOTES:222,BACKSPACE:8,TAB:9,CLEAR:12,ENTER:13,SHIFT:16,CTRL:17,ALT:18,CAPS_LOCK:20,ESC:27,SPACEBAR:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,HELP:47,NUM_LOCK:144}};return o}),define("nexus",{grid:null,board:null,mouse:null,scene:null,input:null,plane:null}),define("tower",{tileAction:new vg.Signal,objAction:new vg.Signal,userAction:new vg.Signal,saveMap:new vg.Signal,loadMap:new vg.Signal,TILE_CHANGE_HEIGHT:"cell.change.height",TILE_ADD:"cell.add",TILE_REMOVE:"cell.remove"}),define("Input",function(){var e=require("tower"),t=require("nexus"),o=require("keyboard"),n=function(e,n){this.mouse=n,this.mouse.signal.add(this.onMouse,this),this.mouseDelta=new THREE.Vector3,this.mousePanMinDistance=.1,this.heightStep=5,this.editorWorldPos=new THREE.Vector3,this.overTile=null,this._travel=0,o.signal.add(function(e,n){e===o.eventType.DOWN?n===o.code.SHIFT&&(t.scene.controls.enabled=!1):n===o.code.SHIFT&&(t.scene.controls.enabled=!0)},this)};return n.prototype={update:function(){var e=this.mouse.allHits[0];e&&(this.editorWorldPos.x=e.point.x,this.editorWorldPos.y=e.point.z,this.editorWorldPos.z=e.point.y);var t=this.mouseDelta.x-this.mouse.screenPosition.x,o=this.mouseDelta.y-this.mouse.screenPosition.y;this._travel+=Math.sqrt(t*t+o*o)},onMouse:function(t,o){var n;switch(this.mouse.allHits&&this.mouse.allHits[0]&&(n=this.mouse.allHits[0]),t){case vg.MouseCaster.WHEEL:e.userAction.dispatch(vg.MouseCaster.WHEEL,this.overTile,o);break;case vg.MouseCaster.OVER:o&&(this.overTile=o.select()),e.userAction.dispatch(vg.MouseCaster.OVER,this.overTile,n);break;case vg.MouseCaster.OUT:o&&(o.deselect(),this.overTile=null),e.userAction.dispatch(vg.MouseCaster.OUT,this.overTile,n);break;case vg.MouseCaster.DOWN:this.mouseDelta.copy(this.mouse.screenPosition),e.userAction.dispatch(vg.MouseCaster.DOWN,this.overTile,n),this._travel=0;break;case vg.MouseCaster.UP:if(this._travel>this.mousePanMinDistance)break;e.userAction.dispatch(vg.MouseCaster.UP,this.overTile,n);break;case vg.MouseCaster.CLICK:e.userAction.dispatch(vg.MouseCaster.CLICK,this.overTile,n)}}},n}),define("EditorPlane",function(){function e(e,t,o){this.nexus=require("nexus"),this.tower=require("tower"),this.geometry=null,this.mesh=null,this.material=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),this.scene=e,this.grid=t,this.hoverMesh=this.grid.generateTilePoly(new THREE.MeshBasicMaterial({color:1748735,side:THREE.DoubleSide})),this.mouse=o}return e.prototype={generatePlane:function(e,t){this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.geometry=new THREE.PlaneBufferGeometry(e,e,1,1),this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.rotation.x=90*vg.DEG_TO_RAD,this.scene.add(this.mesh)},addHoverMeshToGroup:function(e){this.hoverMesh.parent&&this.hoverMesh.parent.remove(this.hoverMesh),e.add(this.hoverMesh)},update:function(){if(this.mouse.allHits.length&&!this.mouse.pickedObject){var e=this.grid.pixelToCell(this.nexus.input.editorWorldPos);this.hoverMesh.position.copy(this.grid.cellToPixel(e)),this.hoverMesh.position.y+=.1,this.hoverMesh.visible=!0}else this.hoverMesh.visible=!1}},e}),define("motor",function(){function e(){d=!1,window.requestAnimationFrame(i),window.addEventListener("focus",s,!1),window.addEventListener("blur",a,!1)}function t(){d=!0,window.removeEventListener("focus",s,!1),window.removeEventListener("blur",a,!1)}function o(e,t){var o=c(e.toString()),n=r(o);-1===n&&l.push({func:e,scope:t,key:o})}function n(e){var t=c(e.toString()),o=r(t);-1!==o&&l.splice(o,1)}function i(){if(!d){window.requestAnimationFrame(i);for(var e=0;e<l.length;e++){var t=l[e];t.func.call(t.scope||null)}}}function r(e){var t,o=-1;for(t=0;t<l.length;t++)if(o=l[t].key,o===e)return t;return-1}function s(e){d=!1,i()}function a(e){d=!0}function c(e){var t,o,n,i=0;if(0===e.length)return i;for(t=0,n=e.length;n>t;t++)o=e.charCodeAt(t),i=(i<<5)-i+o,i|=0;return i}var d=!1,l=[];return{on:e,off:t,add:o,remove:n}}),define("Editor",function(){function e(){l=r.grid.pixelToCell(r.input.editorWorldPos),r.mouse.down&&s.shift&&r.mouse.allHits&&r.mouse.allHits.length&&(l.equals(u)||o(l),u.copy(l))}function t(e,t,a){r.mouse.allHits[0];switch(e){case vg.MouseCaster.WHEEL:if(s.shift&&t){if(!t.cell)return void t.dispose();h.copy(t.cell),h.tile=null;var u=d-a,v=h.h;if(h.h+=u>0?-c:c,h.h<1&&(h.h=1),r.mouse.wheel=Math.round(h.h/c+(u>0?-1:1)),d=r.mouse.wheel,v===h.h)return;n(t);var E=o(h);E.select(),i.tileAction.dispatch(i.TILE_CHANGE_HEIGHT,E)}break;case vg.MouseCaster.OVER:s.shift&&(t&&r.mouse.rightDown?n(t):!t&&r.mouse.down&&o(l));break;case vg.MouseCaster.OUT:break;case vg.MouseCaster.DOWN:s.shift&&r.mouse.down&&a&&!t&&o(l);break;case vg.MouseCaster.UP:r.mouse.down&&a&&!t?o(l):r.mouse.rightDown&&t&&n(t)}}function o(e){if(e&&!r.board.getTileAtCell(e)){var t=new vg.Cell;t.copy(e),t.h=Math.abs(r.mouse.wheel*c);var o=r.grid.generateTile(t,.95);return r.board.addTile(o),i.tileAction.dispatch(i.TILE_ADD,o),o}}function n(e){r.board.removeTile(e),i.tileAction.dispatch(i.TILE_REMOVE,e)}var i=require("tower"),r=require("nexus"),s=require("keyboard"),a=require("motor"),c=3,d=1,l=null,u=new THREE.Vector3,h=new vg.Cell;return i.userAction.add(t,this),a.add(e),{}}),define("data",{_store:{},changed:new vg.Signal,get:function(e){return this._store[e]||null},set:function(e,t){this.changed.dispatch(e,this._store[e],t),this._store[e]=t},save:function(){window.localStorage.vongrid=JSON.stringify(this._store)},load:function(e){var t=window.localStorage.vongrid;if(e||t)try{this._store=e||JSON.parse(t),this.changed.dispatch("load-success")}catch(o){console.warn("Error loading editor data"),this.changed.dispatch("load-failure")}}});
//# sourceMappingURL=app.js.map
