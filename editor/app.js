define("nexus",{grid:null,board:null,mouse:null,scene:null,input:null,plane:null}),define("tower",{tileAction:new vg.Signal,objAction:new vg.Signal,userAction:new vg.Signal,saveMap:new vg.Signal,loadMap:new vg.Signal,TILE_CHANGE_HEIGHT:"cell.change.height",TILE_ADD:"cell.add",TILE_REMOVE:"cell.remove"}),define("removeTile",function(){function e(e,t,n){t&&r.mouse.down&&o(t)}function t(e,t,n){t&&o(t)}function n(e,t,n){}function o(e){r.board.removeTile(e),i.tileAction.dispatch(i.TILE_REMOVE,e)}var i=require("tower"),r=require("nexus");return{onOver:e,onDown:t,onUp:n,action:o}}),define("addTile",function(){function e(e,t,n){!t&&r.mouse.down&&o(e)}function t(e,t,n){t||o(e)}function n(e,t,n){}function o(e){if(e&&!r.board.getTileAtCell(e)){var t=new vg.Cell;t.copy(e),t.h=Math.abs(r.mouse.wheel*a);var n=r.grid.generateTile(t,.95);return r.board.addTile(n),i.tileAction.dispatch(i.TILE_ADD,n),n}}var i=require("tower"),r=require("nexus"),a=3;return{onOver:e,onDown:t,onUp:n,action:o}}),define("motor",function(){function e(){l=!1,window.requestAnimationFrame(i),window.addEventListener("focus",a,!1),window.addEventListener("blur",s,!1)}function t(){l=!0,window.removeEventListener("focus",a,!1),window.removeEventListener("blur",s,!1)}function n(e,t){var n=c(e.toString()),o=r(n);-1===o&&u.push({func:e,scope:t,key:n})}function o(e){var t=c(e.toString()),n=r(t);-1!==n&&u.splice(n,1)}function i(){if(!l){window.requestAnimationFrame(i);for(var e=0;e<u.length;e++){var t=u[e];t.func.call(t.scope||null)}}}function r(e){var t,n=-1;for(t=0;t<u.length;t++)if(n=u[t].key,n===e)return t;return-1}function a(e){l=!1,i()}function s(e){l=!0}function c(e){var t,n,o,i=0;if(0===e.length)return i;for(t=0,o=e.length;o>t;t++)n=e.charCodeAt(t),i=(i<<5)-i+n,i|=0;return i}var l=!1,u=[];return{on:e,off:t,add:n,remove:o}}),define("keyboard",function(){function e(e){switch(e.keyCode){case 16:n.shift=!0;break;case 17:n.ctrl=!0}n.signal.dispatch(n.eventType.DOWN,e.keyCode)}function t(e){switch(e.keyCode){case 16:n.shift=!1;break;case 17:n.ctrl=!1}n.signal.dispatch(n.eventType.UP,e.keyCode)}var n={shift:!1,ctrl:!1,eventType:{DOWN:"down",UP:"up"},signal:new vg.Signal,on:function(){document.addEventListener("keydown",e,!1),document.addEventListener("keyup",t,!1)},off:function(){document.removeEventListener("keydown",e),document.removeEventListener("keyup",t)},code:{A:"A".charCodeAt(0),B:"B".charCodeAt(0),C:"C".charCodeAt(0),D:"D".charCodeAt(0),E:"E".charCodeAt(0),F:"F".charCodeAt(0),G:"G".charCodeAt(0),H:"H".charCodeAt(0),I:"I".charCodeAt(0),J:"J".charCodeAt(0),K:"K".charCodeAt(0),L:"L".charCodeAt(0),M:"M".charCodeAt(0),N:"N".charCodeAt(0),O:"O".charCodeAt(0),P:"P".charCodeAt(0),Q:"Q".charCodeAt(0),R:"R".charCodeAt(0),S:"S".charCodeAt(0),T:"T".charCodeAt(0),U:"U".charCodeAt(0),V:"V".charCodeAt(0),W:"W".charCodeAt(0),X:"X".charCodeAt(0),Y:"Y".charCodeAt(0),Z:"Z".charCodeAt(0),ZERO:"0".charCodeAt(0),ONE:"1".charCodeAt(0),TWO:"2".charCodeAt(0),THREE:"3".charCodeAt(0),FOUR:"4".charCodeAt(0),FIVE:"5".charCodeAt(0),SIX:"6".charCodeAt(0),SEVEN:"7".charCodeAt(0),EIGHT:"8".charCodeAt(0),NINE:"9".charCodeAt(0),NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,NUMPAD_MULTIPLY:106,NUMPAD_ADD:107,NUMPAD_ENTER:108,NUMPAD_SUBTRACT:109,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,COLON:186,EQUALS:187,UNDERSCORE:189,QUESTION_MARK:191,TILDE:192,OPEN_BRACKET:219,BACKWARD_SLASH:220,CLOSED_BRACKET:221,QUOTES:222,BACKSPACE:8,TAB:9,CLEAR:12,ENTER:13,SHIFT:16,CTRL:17,ALT:18,CAPS_LOCK:20,ESC:27,SPACEBAR:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,HELP:47,NUM_LOCK:144}};return n}),define("toolbag",function(){function e(){h=i.grid.pixelToCell(i.input.editorWorldPos),i.mouse.down&&"ADD_TILE"===ui.activeTool.name&&i.mouse.allHits&&i.mouse.allHits.length&&(h.equals(v)||s.action(h,null),v.copy(h))}function t(e){switch(e){case ui.Tools.ADD_TILE:l=s;break;case ui.Tools.REMOVE_TILE:l=c}}function n(e,t,n){if(!r.ctrl&&!i.mouse.rightDown&&l)switch(e){case vg.MouseCaster.WHEEL:if(i.scene.controls.enabled=!1,r.shift&&t&&i.grid.autogenerated){if(!t.cell)return void t.dispose();E.copy(t.cell),E.tile=null;var a=d-n,v=E.h;if(E.h+=a>0?-u:u,E.h<1&&(E.h=1),i.mouse.wheel=Math.round(E.h/u+(a>0?-1:1)),d=i.mouse.wheel,v===E.h)return;c.action(t);var g=s.action(E);g.select(),o.tileAction.dispatch(o.TILE_CHANGE_HEIGHT,g)}break;case vg.MouseCaster.OVER:l.onOver(h,t,n);break;case vg.MouseCaster.OUT:break;case vg.MouseCaster.DOWN:l.onDown(h,t,n);break;case vg.MouseCaster.UP:l.onUp(h,t,n)}}var o=require("tower"),i=require("nexus"),r=require("keyboard"),a=require("motor"),s=require("addTile"),c=require("removeTile"),l=s,u=3,d=1,h=null,v=new THREE.Vector3,E=new vg.Cell;return o.userAction.add(n,this),ui.on(ui.Events.TOOL_CHANGE,t),a.add(e),{}}),window.addEventListener("load",function(e){function t(){10>O&&(O++,10===O&&(M.active=!0)),f&&(A--,0===A&&(f=!1,s.set("map",E),s.save(),console.log("Map saved"))),M.update(),D.update(),P.update(),C.render()}function n(){M.active=!1,O=0}function o(){f=!0,A=g,E=T.toJSON()}function i(e){T.fromJSON(e),w.setGrid(T),e.autogenerated&&w.generateTilemap();var t=20;P.generatePlane(t*t*1.8,t*t*1.8),w.generateOverlay(),ui.trigger(ui.Events.UPDATE_SETTINGS,{mapSize:T.size,cellSize:T.cellSize}),console.log("Map load complete")}function r(){var e=null;E=T.toJSON();try{e=JSON.stringify(E,null,"	"),e=e.replace(/[\n\t]+([\d\.e\-\[\]]+)/g,"$1")}catch(t){e=JSON.stringify(E)}a(e,"hex-map.json")}function a(e,t){var n=new Blob([e],{type:"text/plain"}),o=URL.createObjectURL(n);_.href=o,_.download=t||"data.json",_.target="_blank";var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),_.dispatchEvent(i)}var s=require("data"),c=require("tower"),l=require("nexus"),u=require("keyboard"),d=require("motor"),h=require("Input"),v=require("EditorPlane");s.load();var E=s.get("map"),g=200,A=10,f=!1,p=document.createElement("input");p.type="file",p.addEventListener("change",function(e){var t=p.files[0];if(t){var n=new FileReader;return n.onload=function(e){var t=null;try{t=JSON.parse(e.target.result)}catch(n){return void console.warn("File is not json format")}i(t)},n.readAsText(t),!1}}),ui.on("error",function(e){console.warn(e)}),ui.on(ui.Events.SAVE_MAP,function(){r()}),ui.on(ui.Events.LOAD_MAP,function(){p.click()}),u.on(),d.on();var m=document.getElementById("view"),C=new vg.Scene({element:m,cameraPosition:{x:0,y:300,z:120}},{maxPolarAngle:Math.PI/2-.01});C.controls.addEventListener("wheel",n);var T=new vg.HexGrid,w=new vg.Board(T),M=new vg.MouseCaster(w.group,C.camera,m),D=new h(w.group,M),P=new v(w.group,T,M);if(l.input=D,l.plane=P,l.board=w,l.grid=T,l.scene=C,l.mouse=M,c.tileAction.add(o,this),C.focusOn(w.group),E)i(E);else{T.generate({size:5}),w.generateTilemap(),E=T.toJSON(),s.set("map",E),console.log("Created a new map"),ui.trigger(ui.Events.UPDATE_SETTINGS,{mapSize:5,cellSize:10});var S=20;P.generatePlane(S*S*1.8,S*S*1.8),w.generateOverlay()}C.add(w.group),ui.on(ui.Events.UPDATE_SETTINGS,function(e){if(e.mapSize===T.size){if(e.cellSize===T.cellSize)return;T.updateCellSize(e.cellSize);var t=20;P.generatePlane(t*t*1.8,t*t*1.8),w.generateOverlay(),T.autogenerated&&w.generateTilemap()}else T.updateCellSize(e.cellSize),T.generate({size:e.mapSize}),t=20,P.generatePlane(t*t*1.8,t*t*1.8),w.generateOverlay(),T.autogenerated&&w.generateTilemap();o()}),d.add(t);var O=10,_=document.createElement("a");_.style.display="none",document.body.appendChild(_)}),define("Input",function(){var e=require("tower"),t=require("nexus"),n=require("keyboard"),o=function(e,t){this.mouse=t,this.mouse.signal.add(this.onMouse,this),this.mouseDelta=new THREE.Vector3,this.mousePanMinDistance=.1,this.heightStep=5,this.editorWorldPos=new THREE.Vector3,this.overTile=null,this._travel=0};return o.prototype={update:function(){var e=this.mouse.allHits[0];e&&(this.editorWorldPos.x=e.point.x,this.editorWorldPos.y=e.point.y,this.editorWorldPos.z=e.point.z);var o=this.mouseDelta.x-this.mouse.screenPosition.x,i=this.mouseDelta.y-this.mouse.screenPosition.y;this._travel+=Math.sqrt(o*o+i*i),n.ctrl?t.scene.controls.enabled=!0:t.scene.controls.enabled=!1},onMouse:function(t,n){var o;switch(this.mouse.allHits&&this.mouse.allHits[0]&&(o=this.mouse.allHits[0]),t){case vg.MouseCaster.WHEEL:e.userAction.dispatch(vg.MouseCaster.WHEEL,this.overTile,n);break;case vg.MouseCaster.OVER:n&&(this.overTile=n.select()),e.userAction.dispatch(vg.MouseCaster.OVER,this.overTile,o);break;case vg.MouseCaster.OUT:n&&(n.deselect(),this.overTile=null),e.userAction.dispatch(vg.MouseCaster.OUT,this.overTile,o);break;case vg.MouseCaster.DOWN:this.mouseDelta.copy(this.mouse.screenPosition),e.userAction.dispatch(vg.MouseCaster.DOWN,this.overTile,o),this._travel=0;break;case vg.MouseCaster.UP:if(this._travel>this.mousePanMinDistance)break;e.userAction.dispatch(vg.MouseCaster.UP,this.overTile,o);break;case vg.MouseCaster.CLICK:e.userAction.dispatch(vg.MouseCaster.CLICK,this.overTile,o)}}},o}),define("EditorPlane",function(){function e(e,t,n){this.nexus=require("nexus"),this.tower=require("tower"),this.geometry=null,this.mesh=null,this.material=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),this.scene=e,this.grid=t,this.mouse=n,this.hoverMesh=null}return e.prototype={generatePlane:function(e,t){this.mesh&&this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.geometry=new THREE.PlaneBufferGeometry(e,e,1,1),this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.rotation.x=90*vg.DEG_TO_RAD,this.scene.add(this.mesh),this.hoverMesh&&this.hoverMesh.parent&&this.hoverMesh.parent.remove(this.hoverMesh),this.hoverMesh=this.grid.generateTilePoly(new THREE.MeshBasicMaterial({color:1748735,side:THREE.DoubleSide})),this.nexus.scene.container.add(this.hoverMesh)},update:function(){if(this.mouse.allHits.length&&!this.mouse.pickedObject){var e=this.grid.pixelToCell(this.nexus.input.editorWorldPos);this.hoverMesh.position.copy(this.grid.cellToPixel(e)),this.hoverMesh.position.y+=.1,this.hoverMesh.visible=!0}else this.hoverMesh.visible=!1}},e}),define("data",{_store:{},changed:new vg.Signal,get:function(e){return this._store[e]||null},set:function(e,t){this.changed.dispatch(e,this._store[e],t),this._store[e]=t},save:function(){window.localStorage.vongrid=JSON.stringify(this._store)},load:function(e){var t=window.localStorage.vongrid;if(e||t)try{this._store=e||JSON.parse(t),this.changed.dispatch("load-success")}catch(n){console.warn("Error loading editor data"),this.changed.dispatch("load-failure")}}});
//# sourceMappingURL=app.js.map
