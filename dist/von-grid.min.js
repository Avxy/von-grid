var vg={VERSION:"0.1.1",PI:Math.PI,TAU:2*Math.PI,DEG_TO_RAD:.0174532925,RAD_TO_DEG:57.2957795,SQRT3:Math.sqrt(3),TILE:"tile",ENT:"entity",STR:"structure",HEX:"hex",SQR:"square",ABS:"abstract"};vg.Board=function(t,e){if(!t)throw new Error("You must pass in a grid system for the board to use.");this.group=new THREE.Object3D,this.grid=null,this.overlay=null,this.finder=new vg.AStarFinder(e),vg.Loader.init(),this.setGrid(t)},vg.Board.prototype={placeEntityAtCell:function(t,e){this.grid.cellToPixel(e,t.position),t.position.y+=t.offsetY,t.cell&&(t.cell.entity=null),t.cell=e,e.entity=t},placeAtCell:function(t,e){},findPath:function(t,e,i){return this.finder.findPath(t,e,i,this.grid)},getRandomCell:function(){return this.grid.getRandomCell()},setGrid:function(t){this.grid&&(this.group.remove(this.grid.group),this.grid.dispose()),this.grid=t,this.group.add(t.group)},generateOverlay:function(t){var e=new THREE.LineBasicMaterial({color:0,opacity:.3});this.overlay&&this.group.remove(this.overlay),this.overlay=new THREE.Object3D;var i,s,n,h=new THREE.Vector3;if(this.grid.type===vg.HEX){for(i=-t;t+1>i;i++)for(s=-t;t+1>s;s++)if(n=-i-s,Math.abs(i)<=t&&Math.abs(s)<=t&&Math.abs(n)<=t){h.set(i,s,n);var r=new THREE.Line(this.grid.cellGeo,e);this.grid.setPositionToCell(r.position,h),r.rotation.x=90*vg.DEG_TO_RAD,this.overlay.add(r)}}else this.grid.type===vg.SQR||console.warn("The board cannot generate "+this.grid.type+"-type grid overlays");this.group.add(this.overlay)}},vg.Cell={q:0,r:0,h:1,tile:null,userData:{},walkable:!0,_calcCost:0,_priority:0,_visited:!1,_parent:null},vg.Hex=function(t,e,i,s){this.material=s,this.geo=i,this.size=t,this.width=2*this.size,this.height=.5*vg.SQRT3*this.width,this.depth=t,this.uniqueID=vg.Tools.generateID(),this.objectType=vg.TILE,this.gridPos=null,this.entity=null,this.userData={},this.selected=!1,this.highlight="0x16A8F7",this.walkable=!0,this.calcCost=0,this.priority=0,this.visited=!1,this.parent=null;var n=vg.Tools.randomizeRGB("30, 30, 30",10);this.material||(this.material=new THREE.MeshPhongMaterial({color:n})),this.mesh=new THREE.Mesh(i,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,this.rotation.x=-90*vg.DEG_TO_RAD,this.mesh.scale.set(e,e,e),this.material.emissive?this._emissive=this.material.emissive.getHex():this._emissive=null},vg.Hex.prototype={select:function(){return this.material.emissive&&this.material.emissive.setHex(this.highlight),this.selected=!0,this},deselect:function(){return null!==this._emissive&&this.material.emissive&&this.material.emissive.setHex(this._emissive),this.selected=!1,this},placeAt:function(t){this.position.x=t.x*this.width*.75,this.position.y=0,this.position.z=(t.z-t.y)*this.height*.5,this.gridPos=t,t.w=this},dispose:function(){}},vg.HexGrid=function(t){t||(t={});var e={rings:5,url:null,cellSize:10,cellDepth:1,cellScale:.95,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};vg.Tools.merge(!0,e,t),this.type=vg.HEX,this.size=e.rings,this.cellSize=e.cellSize,this.cellScale=e.cellScale,this.cellSides=6,this.extrudeSettings=e.extrudeSettings,this.extrudeSettings.amount=e.cellDepth,this.rotationIncrement=30*vg.DEG_TO_RAD,this.cells={},this.numCells=0,this.meshes=[],this.cellShape=null,this.cellWidth=2*this.cellSize,this.cellHeight=.5*vg.SQRT3*this.cellWidth,this.hashDelimeter=".",this.group=new THREE.Object3D;var i,s=[];for(i=0;6>i;i++)s.push(this.createVert(i));for(this.cellShape=new THREE.Shape,this.cellShape.moveTo(s[0].x,s[0].y),i=1;6>i;i++)this.cellShape.lineTo(s[i].x,s[i].y);this.cellShape.lineTo(s[0].x,s[0].y),this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=s,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._directions=[new THREE.Vector3(1,-1,0),new THREE.Vector3(1,0,-1),new THREE.Vector3(0,1,-1),new THREE.Vector3(-1,1,0),new THREE.Vector3(-1,0,1),new THREE.Vector3(0,-1,1)],this._diagonals=[new THREE.Vector3(2,-1,-1),new THREE.Vector3(1,1,-2),new THREE.Vector3(-1,2,-1),new THREE.Vector3(-2,1,1),new THREE.Vector3(-1,-1,2),new THREE.Vector3(1,-2,1)],this._list=[],this._vec3=new THREE.Vector3,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[],e.url?vg.Tools.getJSON(e.url,this.load,this):this.generate(),this.cellWidth=2*this.cellSize,this.cellHeight=Math.sqrt(3)/2*this.cellSize},vg.HexGrid.prototype={cellToPixel:function(t,e){var i=this.axialToPixel(t.gridPos);e.x=i.x,e.y=t.depth,e.z=-i.y},project:function(t,e){return this._vec3.x=t.x,this._vec3.z=-t.y,this._vec3.y=e,this._vec3},getCellAt:function(t){var e=t.x*(2/3/this.cellSize),i=(-t.x/3+vg.SQRT3/3*t.y)/this.cellSize;return this._vec3.set(e,i,0),this._vec3.x=this._vec3.x*this.cellWidth*.75,this._vec3.z=(this._vec3.z-this._vec3.y)*this.cellHeight*.5,this._vec3.y=0,this._vec3.z=-this._vec3.y,this._vec3},setPositionToCell:function(t,e){t.x=e.x*this.cellWidth*.75,t.y=0,t.z=(e.z-e.y)*this.cellHeight},getTileAtCell:function(t){return this.cells[this.cubeToHash(t)]},pixelToCell:function(t){var e=t.x*(2/3/this.cellSize),i=(-t.x/3+vg.SQRT3/3*t.y)/this.cellSize;return this._vec3.set(e,i,0),this.axialRound(this._vec3)},getNeighbors:function(t,e,i){var s,n,h=this._directions.length;for(this._list.length=0,s=0;h>s;s++)this._vec3.copy(t.gridPos),this._vec3.add(this._directions[s]),n=this.cells[this.cubeToHash(this._vec3)],!n||i&&!i(t,n.w)||this._list.push(n.w);if(e)for(s=0;h>s;s++)this._vec3.copy(t.gridPos),this._vec3.add(this._diagonals[s]),n=this.cells[this.cubeToHash(this._vec3)],!n||i&&!i(t,n.w)||this._list.push(n.w);return this._list},distance:function(t,e){var i=this.cubeDistance(t.gridPos,e.gridPos);return i+=e.depth-t.depth},clearPath:function(){var t,e;for(t in this.cells)e=this.cells[t].w,e.calcCost=0,e.priority=0,e.parent=null,e.visited=!1},traverse:function(t){var e;for(e in this.cells)t(this.cells[e].w)},getRandomCell:function(){var t,e=0,i=vg.Tools.randomInt(0,this.numCells);for(t in this.cells){if(e===i)return this.cells[t].w;e++}return this.cells[t].w},generateTile:function(t,e){t=Math.abs(t)||this.extrudeSettings.amount,this.extrudeSettings.amount=t;var i=this._geoCache[t];i||(i=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[t]=i);var s=new vg.Hex(this.cellSize,this.cellScale,i,e);return s.depth=t,s},generateTilePoly:function(t){t||(t=new THREE.MeshBasicMaterial({color:2405631}));var e=new THREE.Mesh(this.cellShapeGeo,t);return this._vec3.set(1,0,0),e.rotateOnAxis(this._vec3,vg.PI/2),e},generate:function(){var t,e,i,s;for(s=new THREE.Vector3,this.meshes=[],t=-this.size;t<this.size+1;t++)for(e=-this.size;e<this.size+1;e++)i=-t-e,Math.abs(t)<=this.size&&Math.abs(e)<=this.size&&Math.abs(i)<=this.size&&(s.set(t,e,i),this.add(s))},createVert:function(t){var e=vg.TAU/6*t;return new THREE.Vector3(this.cellSize*Math.cos(e),this.cellSize*Math.sin(e),0)},add:function(t,e){var i=new THREE.Vector3;return i.copy(t),e&&(i.w=e,e.placeAt(i),this.meshes.push(e),this.group.add(e.mesh)),this.cells[this.cubeToHash(i)]=i,this.numCells++,e},remove:function(t){delete this.cells[this.cubeToHash(t.gridPos)],t.gridPos.w=null;var e=this.meshes.indexOf(t);-1!==e&&this.meshes.splice(e,1),this.group.remove(t.mesh),this.numCells--,t.dispose()},dispose:function(){},load:function(t){var e,i,s,n,h,r=t.cells;for(this.meshes=[],this.group=new THREE.Object3D,this.cells={},this.numCells=0,e=0;e<r.length;e++)i=r[e],n=this._geoCache[i.depth],n||(this.extrudeSettings.amount=i.depth,n=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[i.depth]=n),s=new vg.Hex(this.cellSize,this.cellScale,n,h),s.depth=this.extrudeSettings.amount,s.userData.mapData=i.customData,this.add(i,s)},toJSON:function(){var t,e,i=[];for(e in this.cells)t=this.cells[e],i.push({x:t.x,y:t.y,z:t.z,depth:t.w.depth,matCacheId:0,customData:t.w.userData.mapData});return i},cubeToHash:function(t){return t.x+this.hashDelimeter+t.y+this.hashDelimeter+t.z},pixelToAxial:function(t){var e,i;return e=t.x*(2/3/this.cellSize),i=(-t.x/3+vg.SQRT3/3*t.y)/this.cellSize,this._vec3.set(e,i,0),this.axialRound(this._vec3)},axialToCube:function(t){return{x:t.x,y:t.y,z:-t.x-t.y}},cubeToAxial:function(t){return t},axialToPixel:function(t){var e,i;return e=t.x*this.cellWidth*.75,i=(t.z-t.y)*this.cellHeight*.5,{x:e,y:-i}},hexToPixel:function(t){var e,i;return e=1.5*this.cellSize*t.x,i=this.cellSize*vg.SQRT3*(t.y+.5*t.x),{x:e,y:i}},axialRound:function(t){return this.cubeRound(this.axialToCube(t))},cubeRound:function(t){var e=Math.round(t.x),i=Math.round(t.y),s=Math.round(t.z),n=Math.abs(e-t.x),h=Math.abs(i-t.y),r=Math.abs(s-t.z);return n>h&&n>r?e=-i-s:h>r?i=-e-s:s=-e-i,this._conversionVec.set(e,i,s)},cubeDistance:function(t,e){return Math.max(Math.abs(t.x-e.x),Math.abs(t.y-e.y),Math.abs(t.z-e.z))}},vg.Square=function(t,e,i,s){this.type=vg.Square.FLAT,this.material=s,this.geo=i,this.size=t,this.depth=t,this.uniqueID=vg.Tools.generateID(),this.objectType=vg.TILE,this.gridPos=null,this.entity=null,this.width=t,this.height=t,this.selected=!1,this.highlight="0x222266",this.walkable=!0,this.calcCost=0,this.priority=0,this.visited=!1,this.parent=null;var n=vg.Tools.randomizeRGB("30, 30, 30",10);this.material||(this.material=new THREE.MeshPhongMaterial({color:n})),this.mesh=new THREE.Mesh(i,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,this.rotation.x=-90*.0174532925,this.mesh.scale.set(e,e,e),this._emissive=this.material.emissive.getHex()},vg.Square.FLAT=0,vg.Square.POINTY=45*.0174532925,vg.Square.prototype={select:function(){this.material.emissive.setHex(this.highlight),this.selected=!0},deselect:function(){this.material.emissive.setHex(this._emissive),this.selected=!1},placeAt:function(t){this.position.x=t.x*this.size,this.position.y=0,this.position.z=t.z*this.size,this.gridPos=t}},vg.SquareGrid=function(t){var e,i,s;t||(t={});var n={width:5,height:5,type:vg.Square.FLAT,cellSize:10,cellScale:.95,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};vg.Tools.merge(!0,n,t),this.width=n.width,this.height=n.height,this.cellSize=n.cellSize,this.cellScale=n.cellScale,this.type=n.type||vg.Square.FLAT,this.rotationIncrement=vg.Square.POINTY,this.cells={},this.numCells=0,this.meshes=null,this.boxShape=null,this.boxGeo=null,this.boxMat=n.material,this.hashDelimeter=".",this.group=new THREE.Group;var h=this.width/2,r=this.height/2;for(e=-h;h>e;e++)for(i=-r;r>i;i++)s=new THREE.Vector3(e,0,i+1),s.w=null,this.cells[this.boxToHash(s)]=s,this.numCells++;var o,a,l;this.boxShape=new THREE.Shape,this.boxShape.moveTo(0,0),this.boxShape.lineTo(0,this.cellSize),this.boxShape.lineTo(this.cellSize,this.cellSize),this.boxShape.lineTo(this.cellSize,0),this.boxShape.lineTo(0,0),this.boxGeo=new THREE.ExtrudeGeometry(this.boxShape,n.extrudeSettings),this.meshes=[];for(o in this.cells)a=new vg.Square(this.cellSize,this.cellScale,this.boxGeo,this.boxMat),l=this.cells[o],l.w=a,a.depth=n.extrudeSettings.amount,a.placeAt(l),this.meshes.push(a),this.group.add(a.mesh);this.group.rotation.y=this.type,this._directions=[new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,1)],this._diagonals=[new THREE.Vector3(-1,0,-1),new THREE.Vector3(-1,0,1),new THREE.Vector3(1,0,1),new THREE.Vector3(1,0,-1)],this._list=[],this._vec3=new THREE.Vector3},vg.SquareGrid.prototype={cellToPixel:function(t,e){e.x=t.position.x+this.cellSize/2,e.y=t.depth+t.depth/2,e.z=t.position.z-this.cellSize/2},getNeighbors:function(t,e,i){var s,n,h=this._directions.length;for(this._list.length=0,s=0;h>s;s++)this._vec3.copy(t.gridPos),this._vec3.add(this._directions[s]),n=this.cells[this.boxToHash(this._vec3)],!n||i&&i(n.w)||this._list.push(n.w);if(e)for(s=0;h>s;s++)this._vec3.copy(t.gridPos),this._vec3.add(this._diagonals[s]),n=this.cells[this.boxToHash(this._vec3)],!n||i&&i(n.w)||this._list.push(n.w);return this._list},distance:function(t,e){var i=t.gridPos,s=e.gridPos;return Math.abs(i.x-s.x)+Math.abs(i.z-s.z)},clearPath:function(){var t,e;for(t in this.cells)e=this.cells[t].w,e.calcCost=0,e.priority=0,e.parent=null,e.visited=!1},traverse:function(t){var e;for(e in this.cells)t(this.cells[e].w)},getRandomCell:function(){var t,e=0,i=vg.Tools.randomInt(0,this.numCells);for(t in this.cells){if(e===i)return this.cells[t].w;e++}return this.cells[t].w},boxToHash:function(t){return t.x+this.hashDelimeter+t.z}},function(){var t=function(){this.obj=null,this.next=null,this.prev=null,this.free=!0},e=function(){this.first=null,this.last=null,this.length=0,this.objToNodeMap={},this.uniqueID=Date.now()+""+Math.floor(1e3*Math.random()),this.sortArray=[]};e.generateID=function(){return Math.random().toString(36).slice(2)+Date.now()},e.prototype={getNode:function(t){return this.objToNodeMap[t.uniqueID]},addNode:function(i){var s=new t;if(!i.uniqueID)try{i.uniqueID=e.generateID(),console.log("New ID: "+i.uniqueID)}catch(n){return console.error("[LinkedList.addNode] obj passed is immutable: cannot attach necessary identifier"),null}return s.obj=i,s.free=!1,this.objToNodeMap[i.uniqueID]=s,s},swapObjects:function(t,e){this.objToNodeMap[t.obj.uniqueID]=null,this.objToNodeMap[e.uniqueID]=t,t.obj=e},add:function(t){var e=this.objToNodeMap[t.uniqueID];if(e){if(e.free===!1)return;e.obj=t,e.free=!1,e.next=null,e.prev=null}else e=this.addNode(t);if(this.first){if(!this.last)throw new Error("[LinkedList.add] No last in the list -- that shouldn't happen here");this.last.next=e,e.prev=this.last,this.last=e,e.next=null}else this.first=e,this.last=e,e.next=null,e.prev=null;this.length++,this.showDebug&&this.dump("after add")},has:function(t){return!!this.objToNodeMap[t.uniqueID]},moveUp:function(t){this.dump("before move up");var e=this.getNode(t);if(!e)throw"Oops, trying to move an object that isn't in the list";if(e.prev){var i=e.prev,s=i.prev;e==this.last&&(this.last=i);var n=e.next;s&&(s.next=e),e.next=i,e.prev=i.prev,i.next=n,i.prev=e,this.first==i&&(this.first=e)}},moveDown:function(t){var e=this.getNode(t);if(!e)throw"Oops, trying to move an object that isn't in the list";if(e.next){var i=e.next;this.moveUp(i.obj),this.last==i&&(this.last=e)}},sort:function(t){var e,i,s=this.sortArray,n=this.first;for(s.length=0;n;)s.push(n.obj),n=n.next;for(this.clear(),s.sort(t),i=s.length,e=0;i>e;e++)this.add(s[e])},remove:function(t){var e=this.getNode(t);return!e||e.free?!1:(e.prev&&(e.prev.next=e.next),e.next&&(e.next.prev=e.prev),e.prev||(this.first=e.next),e.next||(this.last=e.prev),e.free=!0,e.prev=null,e.next=null,this.length--,!0)},shift:function(){var t=this.first;return 0===this.length?null:(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),this.first=t.next,t.next||(this.last=null),t.free=!0,t.prev=null,t.next=null,this.length--,t.obj)},pop:function(){var t=this.last;return 0===this.length?null:(t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),this.last=t.prev,t.prev||(this.first=null),t.free=!0,t.prev=null,t.next=null,this.length--,t.obj)},concat:function(t){for(var e=t.first;e;)this.add(e.obj),e=e.next},clear:function(){for(var t=this.first;t;)t.free=!0,t=t.next;this.first=null,this.length=0},dispose:function(){for(var t=this.first;t;)t.obj=null,t=t.next;this.first=null,this.objToNodeMap=null},dump:function(t){console.log("===================="+t+"=====================");for(var e=this.first;e;)console.log("{"+e.obj.toString()+"} previous="+(e.prev?e.prev.obj:"NULL")),e=e.next();console.log("==================================="),console.log("Last: {"+(this.last?this.last.obj:"NULL")+"} First: {"+(this.first?this.first.obj:"NULL")+"}")}},e.prototype.constructor=e,vg.LinkedList=e}(),function(){var t=function(t,e,i,s,n){this._listener=e,this.isOnce=i,this.context=s,this.signal=t,this._priority=n||0};t.prototype={active:!0,params:null,execute:function(t){var e,i;return this.active&&this._listener&&(i=this.params?this.params.concat(t):t,e=this._listener.apply(this.context,i),this.isOnce&&this.detach()),e},detach:function(){return this.isBound()?this.signal.remove(this._listener,this.context):null},isBound:function(){return!!this.signal&&!!this._listener},_destroy:function(){delete this.signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this.isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},t.prototype.constructor=t;var e=function(){this._bindings=[],this._prevParams=null;var t=this;this.dispatch=function(){e.prototype.dispatch.apply(t,arguments)}};e.prototype={memorize:!1,_shouldPropagate:!0,active:!0,validateListener:function(t,e){if("function"!=typeof t)throw new Error("Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",e))},_registerListener:function(e,i,s,n){var h,r=this._indexOfListener(e,s);if(-1!==r){if(h=this._bindings[r],h.isOnce!==i)throw new Error("You cannot add"+(i?"":"Once")+"() then add"+(i?"Once":"")+"() the same listener without removing the relationship first.")}else h=new t(this,e,i,s,n),this._addBinding(h);return this.memorize&&this._prevParams&&h.execute(this._prevParams),h},_addBinding:function(t){var e=this._bindings.length;do e--;while(this._bindings[e]&&t._priority<=this._bindings[e]._priority);this._bindings.splice(e+1,0,t)},_indexOfListener:function(t,e){for(var i,s=this._bindings.length;s--;)if(i=this._bindings[s],i._listener===t&&i.context===e)return s;return-1},has:function(t,e){return-1!==this._indexOfListener(t,e)},add:function(t,e,i){return this.validateListener(t,"add"),this._registerListener(t,!1,e,i)},addOnce:function(t,e,i){return this.validateListener(t,"addOnce"),this._registerListener(t,!0,e,i)},remove:function(t,e){this.validateListener(t,"remove");var i=this._indexOfListener(t,e);return-1!==i&&(this._bindings[i]._destroy(),this._bindings.splice(i,1)),t},removeAll:function(t){"undefined"==typeof t&&(t=null);for(var e=this._bindings.length;e--;)t?this._bindings[e].context===t&&(this._bindings[e]._destroy(),this._bindings.splice(e,1)):this._bindings[e]._destroy();t||(this._bindings.length=0)},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(){if(this.active){var t,e=Array.prototype.slice.call(arguments),i=this._bindings.length;if(this.memorize&&(this._prevParams=e),i){t=this._bindings.slice(),this._shouldPropagate=!0;do i--;while(t[i]&&this._shouldPropagate&&t[i].execute(e)!==!1)}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},e.prototype.constructor=e,vg.Signal=e}(),vg.AStarFinder=function(t){t=t||{},this.allowDiagonal=!1,this.heuristicFilter=null,vg.Tools.merge(this,t),this.list=new vg.LinkedList},vg.AStarFinder.prototype={findPath:function(t,e,i,s){var n,h,r,o,a,l;for(i=i||this.heuristicFilter,s.clearPath(),this.list.clear(),this.list.add(t);this.list.length>0;){if(this.list.sort(this.compare),n=this.list.shift(),n.visited=!0,n===e)return vg.PathUtil.backtrace(e);for(r=s.getNeighbors(n,this.allowDiagonal,i),a=0,l=r.length;l>a;a++)if(o=r[a],o.walkable&&(h=n.calcCost+s.distance(n,o),!o.visited||h<o.calcCost)){if(o.visited=!0,o.parent=n,o.calcCost=h,o.priority=h+s.distance(e,o),o===e)return vg.PathUtil.backtrace(e);this.list.add(o)}}return null},compare:function(t,e){return t.priority-e.priority}},vg.PathUtil={backtrace:function(t){for(var e=[t];t.parent;)t=t.parent,e.push(t);return e.reverse()},biBacktrace:function(t,e){var i=this.backtrace(t),s=this.backtrace(e);return i.concat(s.reverse())},pathLength:function(t){var e,i,s,n,h,r=0;for(e=1;e<t.length;++e)i=t[e-1],s=t[e],n=i[0]-s[0],h=i[1]-s[1],r+=Math.sqrt(n*n+h*h);return r},interpolate:function(t,e,i,s){var n,h,r,o,a,l,c=Math.abs,u=[];for(r=c(i-t),o=c(s-e),n=i>t?1:-1,h=s>e?1:-1,a=r-o;t!==i||e!==s;)u.push([t,e]),l=2*a,l>-o&&(a-=o,t+=n),r>l&&(a+=r,e+=h);return u},expandPath:function(t){var e,i,s,n,h,r,o=[],a=t.length;if(2>a)return o;for(h=0;a-1>h;++h)for(e=t[h],i=t[h+1],s=this.interpolate(e[0],e[1],i[0],i[1]),n=s.length,r=0;n-1>r;++r)o.push(s[r]);return o.push(t[a-1]),o},smoothenPath:function(t,e){var i,s,n,h,r,o,a,l,c,u,d,g,p=e.length,v=e[0][0],f=e[0][1],m=e[p-1][0],w=e[p-1][1];for(i=v,s=f,r=[[i,s]],a=2;p>a;++a){for(c=e[a],n=c[0],h=c[1],u=this.interpolate(i,s,n,h),g=!1,l=1;l<u.length;++l)if(d=u[l],!t.isWalkableAt(d[0],d[1])){g=!0;break}g&&(o=e[a-1],r.push(o),i=o[0],s=o[1])}return r.push([m,w]),r},compressPath:function(t){if(t.length<3)return t;var e,i,s,n,h,r,o=[],a=t[0][0],l=t[0][1],c=t[1][0],u=t[1][1],d=c-a,g=u-l;for(h=Math.sqrt(d*d+g*g),d/=h,g/=h,o.push([a,l]),r=2;r<t.length;r++)e=c,i=u,s=d,n=g,c=t[r][0],u=t[r][1],d=c-e,g=u-i,h=Math.sqrt(d*d+g*g),d/=h,g/=h,(d!==s||g!==n)&&o.push([e,i]);return o.push([c,u]),o}},vg.Loader={manager:null,imageLoader:null,crossOrigin:!1,init:function(t){this.crossOrigin=t||!1,this.manager=new THREE.LoadingManager(function(){},function(){},function(){console.warn("Error loading images")}),this.imageLoader=new THREE.ImageLoader(this.manager),this.imageLoader.crossOrigin=t},loadTexture:function(t,e,i,s){var n=new THREE.Texture(null,e);return this.imageLoader.load(t,function(t){n.image=t,n.needsUpdate=!0,i&&i(n)},null,function(t){s&&s(t)}),n.sourceFile=t,n}},vg.MouseCaster=function(t,e,i){this.down=!1,this.rightDown=!1,this.pickedObject=null,this.selectedObject=null,this.allHits=null,this.active=!0,this.shift=!1,this.ctrl=!1,this.wheel=0,this.position=new THREE.Vector3,this.screenPosition=new THREE.Vector2,this.signal=new vg.Signal,this.group=t,this._camera=e,this._raycaster=new THREE.Raycaster,this._preventDefault=!1,i=i||document,i.addEventListener("mousemove",this._onDocumentMouseMove.bind(this),!1),i.addEventListener("mousedown",this._onDocumentMouseDown.bind(this),!1),i.addEventListener("mouseup",this._onDocumentMouseUp.bind(this),!1),i.addEventListener("mousewheel",this._onMouseWheel.bind(this),!1),i.addEventListener("DOMMouseScroll",this._onMouseWheel.bind(this),!1)},vg.MouseCaster.OVER="over",vg.MouseCaster.OUT="out",vg.MouseCaster.DOWN="down",vg.MouseCaster.UP="up",vg.MouseCaster.CLICK="click",vg.MouseCaster.WHEEL="wheel",vg.MouseCaster.prototype={update:function(){if(this.active){this._raycaster.setFromCamera(this.screenPosition,this._camera);var t,e,i=this._raycaster.intersectObject(this.group,!0);i.length>0?(t=i[0],e=t.object.userData.structure,this.pickedObject!=e&&(this.pickedObject&&this.signal.dispatch(vg.MouseCaster.OUT,this.pickedObject),this.pickedObject=e,this.selectedObject=null,this.signal.dispatch(vg.MouseCaster.OVER,this.pickedObject)),this.position.copy(t.point),this.screenPosition.z=t.distance):(this.pickedObject&&this.signal.dispatch(vg.MouseCaster.OUT,this.pickedObject),this.pickedObject=null,this.selectedObject=null),this.allHits=i}},preventDefault:function(){this._preventDefault=!0},_onDocumentMouseDown:function(t){return t=t||window.event,t.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.pickedObject&&(this.selectedObject=this.pickedObject),this.shift=t.shiftKey,this.ctrl=t.ctrlKey,this.down=1===t.which,this.rightDown=3===t.which,void this.signal.dispatch(vg.MouseCaster.DOWN,this.pickedObject))},_onDocumentMouseUp:function(t){return t.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.shift=t.shiftKey,this.ctrl=t.ctrlKey,this.signal.dispatch(vg.MouseCaster.UP,this.pickedObject),this.selectedObject&&this.pickedObject&&this.selectedObject.uniqueID===this.pickedObject.uniqueID&&this.signal.dispatch(vg.MouseCaster.CLICK,this.pickedObject),this.down=1===t.which?!1:this.down,void(this.rightDown=3===t.which?!1:this.rightDown))},_onDocumentMouseMove:function(t){t.preventDefault(),this.screenPosition.x=t.clientX/window.innerWidth*2-1,this.screenPosition.y=2*-(t.clientY/window.innerHeight)+1},_onMouseWheel:function(t){if(this.active){t.preventDefault(),t.stopPropagation();var e=0;void 0!==t.wheelDelta?e=t.wheelDelta:void 0!==t.detail&&(e=-t.detail),e>0?this.wheel++:this.wheel--,this.signal.dispatch(vg.MouseCaster.WHEEL,this.wheel)}}},vg.Scene=function(t,e){var i={element:document.body,alpha:!0,antialias:!0,clearColor:"#fff",sortObjects:!1,fog:null,light:new THREE.DirectionalLight(16777215),lightPosition:null,cameraType:"PerspectiveCamera",cameraPosition:null},s={minDistance:100,maxDistance:1e3,zoomSpeed:2,noZoom:!1};if(vg.Tools.merge(i,t),"boolean"!=typeof e&&vg.Tools.merge(s,e),this.renderer=new THREE.WebGLRenderer({alpha:i.alpha,antialias:i.antialias}),this.renderer.setClearColor(i.clearColor,0),this.renderer.sortObjects=i.sortObjects,this.width=window.innerWidth,this.height=window.innerHeight,this.orthoZoom=4,this.container=new THREE.Scene,this.container.fog=i.fog,this.container.add(new THREE.AmbientLight(14540253)),i.lightPosition||i.light.position.set(-1,1,-1).normalize(),this.container.add(i.light),"OrthographicCamera"===i.cameraType){var n=window.innerWidth/this.orthoZoom,h=window.innerHeight/this.orthoZoom;this.camera=new THREE.OrthographicCamera(n/-2,n/2,h/2,h/-2,1,5e3)}else this.camera=new THREE.PerspectiveCamera(50,this.width/this.height,1,5e3);this.contolled=!!e,this.contolled&&(this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=s.minDistance,this.controls.maxDistance=s.maxDistance,this.controls.zoomSpeed=s.zoomSpeed,this.controls.noZoom=s.noZoom),i.cameraPosition&&this.camera.position.copy(i.cameraPosition),window.addEventListener("resize",function(){if(this.width=window.innerWidth,this.height=window.innerHeight,"OrthographicCamera"===this.camera.type){var t=this.width/this.orthoZoom,e=this.height/this.orthoZoom;this.camera.left=t/-2,this.camera.right=t/2,this.camera.top=e/2,this.camera.bottom=e/-2}else this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}.bind(this),!1),this.attachTo(i.element)},vg.Scene.prototype={attachTo:function(t){t.style.width=this.width+"px",t.style.height=this.height+"px",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),t.appendChild(this.renderer.domElement)},add:function(t){this.container.add(t)},remove:function(t){this.container.remove(t)},render:function(){this.contolled&&this.controls.update(),this.renderer.render(this.container,this.camera)},updateOrthoZoom:function(){if(this.orthoZoom<=0)return void(this.orthoZoom=0);var t=this.width/this.orthoZoom,e=this.height/this.orthoZoom;this.camera.left=t/-2,this.camera.right=t/2,this.camera.top=e/2,this.camera.bottom=e/-2,this.camera.updateProjectionMatrix()},focusOn:function(t){this.camera.lookAt(t.position)}},vg.SelectionManager=function(t){this.mouse=t,this.onSelect=new vg.Signal,this.onDeselect=new vg.Signal,this.selected=null,this.toggleSelection=!1,this.mouse.signal.add(this.onMouse,this)},vg.SelectionManager.prototype={select:function(t,e){t&&(e=e||!0,this.selected!==t&&this.clearSelection(e),t.selected?this.toggleSelection&&(e&&this.onDeselect.dispatch(t),t.deselect()):t.select(),this.selected=t,e&&this.onSelect.dispatch(t))},clearSelection:function(t){t=t||!0,this.selected&&(t&&this.onDeselect.dispatch(this.selected),this.selected.deselect()),this.selected=null},onMouse:function(t,e){switch(t){case vg.MouseCaster.DOWN:e||this.clearSelection();break;case vg.MouseCaster.CLICK:this.select(e)}}},vg.Tools={clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},sign:function(t){return t&&t/Math.abs(t)},random:function(t,e){return 1===arguments.length?Math.random()*t-.5*t:Math.random()*(e-t)+t},randomInt:function(t,e){return 1===arguments.length?Math.random()*t-.5*t|0:Math.random()*(e-t+1)+t|0},normalize:function(t,e,i){return(t-e)/(i-e)},getShortRotation:function(t){return t%=this.TAU,t>this.PI?t-=this.TAU:t<-this.PI&&(t+=this.TAU),t},generateID:function(){return Math.random().toString(36).slice(2)+Date.now()},isPlainObject:function(t){if("object"!=typeof t||t.nodeType||t===t.window)return!1;try{if(t.constructor&&!Object.prototype.hasOwnProperty.call(t.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}return!0},merge:function(){var t,e,i,s,n,h,r=arguments[0]||{},o=1,a=arguments.length,l=!1;for("boolean"==typeof r&&(l=r,r=arguments[1]||{},o=2);a>o;){if(null!==(t=arguments[o]))for(e in t)i=r[e],s=t[e],r!==s&&(l&&s&&(this.isPlainObject(s)||(n=Array.isArray(s)))?(n?(n=!1,h=i&&Array.isArray(i)?i:[]):h=i&&this.isPlainObject(i)?i:{},r[e]=this.merge(l,h,s)):void 0!==s&&(r[e]=s));o++}return r},now:function(){return window.nwf?window.nwf.system.Performance.elapsedTime:window.performance.now()},empty:function(t){for(;t.lastChild;)t.removeChild(t.lastChild)},radixSort:function(t,e,i,s){if(e=e||0,i=i||t.length,s=s||31,!(e>=i-1||0>s)){for(var n=e,h=i,r=1<<s;h>n;)if(t[n]&r){--h;var o=t[n];t[n]=t[h],t[h]=o}else++n;this.radixSort(t,e,h,s-1),this.radixSort(t,h,i,s-1)}},randomizeRGB:function(t,e){var i,s,n=t.split(","),h="rgb(";for(e=this.randomInt(e),i=0;3>i;i++)s=parseInt(n[i])+e,0>s?s=0:s>255&&(s=255),h+=s+",";return h=h.substring(0,h.length-1),h+=")"},getJSON:function(t,e,i){var s=new XMLHttpRequest;s.onreadystatechange=function(){return this.readyState<4||200!==this.status?void console.warn("[Tools] Error - "+this.statusText+" - loading "+t):void e.call(i||this,JSON.parse(this.responseText))},s.open("GET",t,!0),s.send("")}};
//# sourceMappingURL=von-grid.min.js.map
